<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="1024 pixels art on Polygon blockchain.">

    <title>1024 Pixels Art</title>
    <link id="linkFavicon" rel="shortcut icon" type="image/x-icon" href="/favicon.ico">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.2/font/bootstrap-icons.css">

    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.10.2/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.12/dist/vue.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.0.32/dist/ethers.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/base64-js@1.5.1/base64js.min.js"></script>
    <script src="static/js/pixels.js"></script>

    <style>
        .nav-link.active {
            cursor: default;
            border-bottom: 2px solid rgba(0, 0, 0, 0.9);
        }

        a {
            text-decoration: none;
        }

        .nft {
            display: inline-block;
            width: 118px;
            padding: 10px;
            margin: 10px;
        }

        .nft:hover {
            background-color: #f8f9fa;
        }

        .nft img {
            width: 98px;
            height: 98px;
            border: 1px solid #ccc;
        }

        .nft:hover img {
            border-color: rgba(0, 0, 0, 0.5);
        }

        .nft .text-center a {
            color: rgba(0, 0, 0, 0.5);
        }

        .nft:hover .text-center a {
            color: #0d6efd;
        }
    </style>

    <script>
        function keccak(str) {
            let arr = new TextEncoder().encode(str);
            return ethers.utils.keccak256(arr);
        }

        function toBN(s, decimals) {
            try {
                return ethers.utils.parseUnits(s.trim(), decimals);
            } catch (e) {
                return null;
            }
        }

        function isValidBN(s, decimals) {
            let bn = toBN(s, decimals);
            return bn !== null && !bn.isZero() && !bn.isNegative();
        }

        function isValidAddress(s) {
            try {
                ethers.utils.getAddress(s);
                return true;
            } catch (e) {
                return false;
            }
        }

        function getWeb3Provider() {
            if (!window.web3Provider) {
                if (!window.ethereum) {
                    console.error("there is no web3 provider.");
                    return null;
                }
                window.web3Provider = new ethers.providers.Web3Provider(window.ethereum, "any");
            }
            return window.web3Provider;
        }

        function showAlert(title, message) {
            let m = $('#alertModal');
            m.find('.x-title').text(title);
            m.find('.x-message').text(message);
            let myModal = new bootstrap.Modal(m.get(0), { backdrop: 'static', keyboard: false });
            myModal.show();
        }

        function showInfo(title, message) {
            let m = $('#infoModal');
            m.find('.x-title').text(title);
            if (message.startsWith('<')) {
                m.find('.x-message').html(message);
            } else {
                m.find('.x-message').text(message);
            }
            let myModal = new bootstrap.Modal(m.get(0), { backdrop: 'static', keyboard: false });
            myModal.show();
        }

        function showTip(msg, isError) {
            let $div = $('<div/>');
            $div.addClass('alert');
            $div.addClass(isError ? 'alert-danger' : 'alert-success');
            $div.text(msg);
            $div.css('display', 'none');
            $('#tips').prepend($div);
            $div.fadeIn().delay(2000).fadeOut();
        }

        function translateError(err) {
            window.err = err;
            if (typeof (err) === 'string') {
                return err;
            }
            if (err.error && err.error.code && err.error.message) {
                return `Error (${err.error.code}): ${err.error.message}`;
            }
            if (err.code && err.message) {
                return `Error (${err.code}): ${err.message}`;
            }
            return err.message || err.toString();
        }

        function init() {
            console.log('init vue...');
            window.vm = new Vue({
                el: '#vm',
                data: {
                    account: null,
                    chainId: 0,
                    search: {
                        tokenId: '',
                        creator: '',
                        owner: '',
                        error: {
                            tokenId: false,
                            creator: false,
                            owner: false
                        }
                    },
                    nfts: [],
                    loading: false,
                    loadError: false,
                    version: 0
                },
                computed: {
                    marketUrl: function () {
                        return window.MARKET_URL;
                    },
                    canSetMe: function () {
                        return this.account !== null;
                    },
                    ready: function () {
                        return this.account && this.chainId === window.CHAIN_ID;
                    },
                    networkName: function () {
                        if (this.account) {
                            if (this.chainId === window.CHAIN_ID) {
                                return window.CHAIN_NAME;
                            }
                            return 'Unsupported Chain (0x' + this.chainId.toString(16) + ')';
                        }
                        return 'Not connected';
                    },
                    wrongNetwork: function () {
                        return this.chainId !== window.CHAIN_ID;
                    }
                },
                methods: {
                    setOwnedByMe: function () {
                        this.search.owner = this.account;
                    },
                    setCreatedByMe: function () {
                        this.search.creator = this.account;
                    },
                    getTokenUrl: function (nft) {
                        return window.SCAN_URL + '/token/' + window.PIXELS_ADDR + '?a=' + nft.id;
                    },
                    getCreatorUrl: function (nft) {
                        return window.SCAN_URL + '/address/' + nft.creator;
                    },
                    getOwnerUrl: function (nft) {
                        return window.SCAN_URL + '/address/' + nft.owner;
                    },
                    getMarketUrl: function (nft) {
                        return window.OPENSEA_URL + window.PIXELS_ADDR + '/' + nft.id;
                    },
                    getReceiptUrl: function (nft) {
                        return window.SCAN_URL + '/tx/' + nft.transactionHash;
                    },
                    searchNFTs: async function () {
                        let
                            tokenId = this.search.tokenId.trim(),
                            owner = this.search.owner.trim(),
                            creator = this.search.creator.trim();

                        // clear errors:
                        for (let k in this.search.error) {
                            this.search.error[k] = false;
                        }

                        // check:
                        if (tokenId !== '' && ! /^[0-9]{1,78}$/.test(tokenId)) {
                            this.search.error.tokenId = true;
                        }
                        if (owner !== '' && !ethers.utils.isAddress(owner.toLowerCase())) {
                            this.search.error.owner = true;
                        }
                        if (creator !== '' && !ethers.utils.isAddress(creator.toLowerCase())) {
                            this.search.error.creator = true;
                        }
                        for (let k in this.search.error) {
                            if (this.search.error[k]) {
                                return;
                            }
                        }

                        this.version++;
                        this.loading = true;
                        this.loadError = false;
                        this.nfts = [];
                        try {
                            let condition = [];
                            if (tokenId) {
                                condition.push(`id: "${tokenId}"`);
                            }
                            if (owner) {
                                condition.push(`owner: "${owner}"`);
                            }
                            if (creator) {
                                condition.push(`creator: "${creator}"`);
                            }
                            let where = '';
                            if (condition.length > 0) {
                                where = `where: {${condition.join(',')}},`;
                            }
                            let query = {
                                "query": `
{
    pixelsNfts(${where} first: 100, orderBy: blockTimestamp, orderDirection: desc) {
    id
    owner
    creator
    blockTimestamp
    transactionHash
    image
  }
}`
                            };
                            let result = await this.postJson(window.GRAPH_URL, query);
                            this.nfts = result.data.pixelsNfts;
                            this.loadError = false;
                        } catch (err) {
                            this.loadError = true;
                        } finally {
                            this.loading = false;
                        }
                    },
                    postJson: async function (url, data) {
                        let opt = {
                            type: 'POST',
                            dataType: 'json',
                            contentType: 'application/json',
                            url: url,
                            data: JSON.stringify(data)
                        };
                        return await $.ajax(opt);
                    },
                    abbrAddress: function (addr) {
                        if (!addr) {
                            return '';
                        }
                        let s = addr.toString();
                        if (s.indexOf('0x') === 0 && s.length === 42) {
                            let addr = ethers.utils.getAddress(s.substring(0));
                            return addr.substring(0, 6) + '...' + addr.substring(38);
                        }
                        return s;
                    },
                    gotoScanUrl: function () {
                        window.open(window.SCAN_URL + '/address/' + this.account);
                    },
                    accountChanged: function (accounts) {
                        console.log('wallet account changed:', accounts.length === 0 ? null : accounts[0]);
                        if (accounts.length === 0) {
                            this.disconnected();
                        } else {
                            this.account = accounts[0];
                            document.cookie = '__account__=' + this.account + ';max-age=1296000';
                        }
                    },
                    disconnected: async function () {
                        console.warn('wallet disconnected.');
                        this.account = null;
                    },
                    chainChanged: function (chainId) {
                        console.log('wallet chainId changed: ' + chainId + ' = ' + parseInt(chainId, 16));
                        this.chainId = parseInt(chainId, 16);
                    },
                    connectWallet: async function () {
                        console.log('try connect wallet...');
                        if (window.getWeb3Provider() === null) {
                            console.error('there is no web3 provider.');
                            return false;
                        }
                        try {
                            this.accountChanged(await window.ethereum.request({
                                method: 'eth_requestAccounts',
                            }));
                            this.chainChanged(await window.ethereum.request({
                                method: 'eth_chainId'
                            }));
                            window.ethereum.on('disconnect', this.disconnected);
                            window.ethereum.on('accountsChanged', this.accountChanged);
                            window.ethereum.on('chainChanged', this.chainChanged);
                        } catch (e) {
                            console.error('could not get a wallet connection.', e);
                            return false;
                        }
                        console.log('wallet connected.');
                        return true;
                    },
                    switchChain: async function () {
                        if (this.wrongNetwork) {
                            await ethereum.request({
                                method: 'wallet_switchEthereumChain',
                                params: [{ chainId: '0x' + window.CHAIN_ID.toString(16) }],
                            });
                        }
                    }
                },
                watch: {
                },
                mounted: async function () {
                    await this.searchNFTs();
                }
            });
        }

        $(function () {
            init();
        });
    </script>
</head>

<body>
    <!-- Loading Modal -->
    <div id="loadingModal" class="modal fade" role="dialog" aria-hidden="true" aria-labelledby="loadingLabel">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header align-items-center d-flex">
                    <h4 class="modal-title x-title" id="loadingLabel">&nbsp;</h4>
                </div>
                <div class="modal-body">
                    <div class="float-start">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                    <div class="ms-5 ps-4 float-none">
                        <p class="x-message">&nbsp;</p>
                    </div>
                </div>
                <!-- <div class="modal-footer">
                    <button class="btn btn-outline-primary" data-bs-dismiss="modal" aria-label="Close">Cancel</button>
                </div> -->
            </div>
        </div>
    </div>

    <!-- Alert Modal -->
    <div id="alertModal" class="modal fade" role="dialog" aria-hidden="true" aria-labelledby="alertLabel">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header align-items-center d-flex">
                    <h4 class="modal-title x-title" id="alertLabel">&nbsp;</h4>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true"><i class="fe fe-x-circle"></i></span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="float-start">
                        <i class="fs-2 text-danger fe fe-alert-triangle"></i>
                    </div>
                    <div class="ms-5 ps-4 float-none">
                        <p class="x-message">&nbsp;</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-outline-primary" data-bs-dismiss="modal" aria-label="Close">OK</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Info Modal -->
    <div id="infoModal" class="modal fade" role="dialog" aria-hidden="true" aria-labelledby="infoLabel">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header align-items-center d-flex">
                    <h4 class="modal-title x-title" id="infoLabel">&nbsp;</h4>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true"><i class="fe fe-x-circle"></i></span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="float-start">
                        <i class="fs-2 fe fe-info"></i>
                    </div>
                    <div class="ms-5 ps-4 float-none">
                        <p class="x-message">&nbsp;</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-outline-primary" data-bs-dismiss="modal" aria-label="Close">OK</button>
                </div>
            </div>
        </div>
    </div>

    <div id="vm" class="container">
        <nav class="navbar navbar-expand-lg navbar-light bg-light border-bottom"
            style="position:fixed; top:0; left:0; right:0; z-index: 99;">
            <div class="container">
                <a class="navbar-brand" href="#0" style="cursor:default"><i class="bi bi-images"></i> 1024 Pixels</a>
                <ul class="mr-2 navbar-nav">
                    <li class="nav-item">
                        <a href="index.html" class="nav-link"><i class="bi bi-image"></i>
                            Create</span></a>
                    </li>
                    <li class="nav-item">
                        <a href="#0" class="nav-link active"><i class="bi bi-list-ul"></i>
                            Browse</span></a>
                    </li>
                    <li class="nav-item">
                        <a v-bind:href="marketUrl" class="nav-link"><i class="bi bi-bag-check"></i>
                            Market</span></a>
                    </li>
                </ul>
                <ul id="wallet" class="mr-2 navbar-nav navbar-right-wrap" style="flex-direction: row !important;">
                    <li class="nav-item">
                        <a v-on:click="switchChain" href="#0" class="nav-link"><i class="bi bi-globe"></i>
                            <span v-text="networkName"></span></a>
                    </li>
                    <li v-if="account===null" class="nav-item">
                        <button v-on:click="connectWallet" type="button" class="btn btn-primary">Connect Wallet</button>
                    </li>
                    <li v-if="account!==null" class="nav-item">
                        <a href="#0" class="nav-link" v-on:click="gotoScanUrl"><i class="bi bi-wallet"></i>
                            <span v-text="abbrAddress(account)"></span> <i class="fe fe-external-link"></i></a>
                    </li>
                </ul>
            </div>
        </nav>

        <div style="padding-top: 80px;">
            <div class="row">
                <div class="col-12">
                    <form onsubmit="return false">
                        <div class="row">
                            <div class="col-2">
                                <div class="mb-3">
                                    <input v-model="search.tokenId" type="text" class="form-control form-control-sm"
                                        v-bind:class="{'is-invalid': search.error.tokenId}" placeholder="Token ID">
                                </div>
                            </div>
                            <div class="col-2">
                                <div class="mb-3">
                                    <input v-model="search.owner" type="text" class="form-control form-control-sm"
                                        v-bind:class="{'is-invalid': search.error.owner}" placeholder="Owner">
                                    <div class="form-text">
                                        <a v-show="canSetMe" v-on:click="setOwnedByMe()" href="#0">Owned by me</a>
                                    </div>
                                </div>
                            </div>
                            <div class="col-2">
                                <input v-model="search.creator" type="text" class="form-control form-control-sm"
                                    v-bind:class="{'is-invalid': search.error.creator}" placeholder="Creator">
                                <div class="form-text">
                                    <a v-show="canSetMe" v-on:click="setCreatedByMe()" href="#0">Created by me</a>
                                </div>
                            </div>
                            <div class="col-2">
                                <button v-on:click="searchNFTs" v-bind:disabled="loading" type="button"
                                    class="btn btn-sm btn-outline-primary">Search</button>
                            </div>
                        </div>
                    </form>
                </div>

                <div class="col-12 mb-4">
                    <div v-show="loading" class="spinner-border" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <div v-show="loadError" class="alert alert-danger">
                        Search failed. Please try later.
                    </div>
                </div>

                <div class="col-12">
                    <div v-show="nfts.length>0" class="mb-4">
                        <div v-for="nft in nfts" class="nft">
                            <div>
                                <img v-bind:src="nft.image">
                            </div>
                            <div class="text-center">
                                <a v-bind:href="getTokenUrl(nft)" title="Token ID" target="_blank"><i
                                        class="bi bi-image"></i></a>
                                <a v-bind:href="getCreatorUrl(nft)" title="Creator" target="_blank"><i
                                        class="bi bi-person-fill-add"></i></a>
                                <a v-bind:href="getOwnerUrl(nft)" title="Owner" target="_blank"><i
                                        class="bi bi-person-fill"></i></a>
                                <a v-bind:href="getMarketUrl(nft)" title="Market" target="_blank"><i
                                        class="bi bi-bag-check"></i></a>
                            </div>
                        </div>
                    </div>
                    <div v-show="nfts.length>=100" class="mb-4 text-center">
                        <span>Only the first of 100 NFTs are displayed.</span>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <footer class="p-5 mt-5 bg-light border-top">
        <div class="container">
            <div class="row">
                <div class="col-12">
                    <div class="mb-4"><i class="bi bi-images"></i> 1024 Pixels, copyleft 2023</div>
                    <ul class="list-unstyled small text-muted">
                        <li class="mb-2">Designed and built by
                            <a target="_blank" href="https://github.com/michaelliao">Michael Liao
                                <i class="bi bi-box-arrow-up-right"></i></a>.
                        </li>
                        <li class="mb-2">Check the source code on
                            <a target="_blank" href="https://github.com/michaelliao/1024pixels">Github
                                <i class="bi bi-box-arrow-up-right"></i></a>
                        </li>
                        <li class="mb-2">Code licensed
                            <a target="_blank"
                                href="https://github.com/michaelliao/1024pixels/blob/master/LICENSE">GPLv3
                                <i class="bi bi-box-arrow-up-right"></i></a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </footer>
</body>

</html>